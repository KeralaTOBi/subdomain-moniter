name: recon
on:
  schedule:
    - cron: "0 */1 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  recon:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Cache Recon Tools
        id: cache-tools
        uses: actions/cache@v4
        with:
          path: ~/recon-tools
          key: ${{ runner.os }}-recon-tools-v5

      - name: Install Tools (Only if Cache Miss)
        if: steps.cache-tools.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/recon-tools
          
          # Subfinder
          LATEST_SUB=$(curl -s https://api.github.com/repos/projectdiscovery/subfinder/releases/latest | jq -r '.tag_name' | sed 's/v//')
          curl -sL "https://github.com/projectdiscovery/subfinder/releases/download/v${LATEST_SUB}/subfinder_${LATEST_SUB}_linux_amd64.zip" -o subfinder.zip
          unzip -o subfinder.zip && mv subfinder ~/recon-tools/
          
          # Assetfinder
          curl -sL "https://github.com/tomnomnom/assetfinder/releases/download/v0.1.1/assetfinder-linux-amd64-0.1.1.tgz" -o assetfinder.tgz
          tar -xvf assetfinder.tgz && mv assetfinder ~/recon-tools/

          # Amass
          LATEST_AMASS=$(curl -s https://api.github.com/repos/owasp-amass/amass/releases/latest | jq -r '.tag_name')
          curl -sL "https://github.com/owasp-amass/amass/releases/download/${LATEST_AMASS}/amass_linux_amd64.tar.gz" -o amass.tar.gz
          tar -xzvf amass.tar.gz
          find . -name "amass" -type f -exec mv {} ~/recon-tools/ \;

          # ANEW (The magic tool for 'New' detection)
          curl -sL "https://github.com/tomnomnom/anew/releases/download/v0.1.1/anew-linux-amd64-0.1.1.tgz" -o anew.tgz
          tar -xvf anew.tgz && mv anew ~/recon-tools/

          rm -rf *.zip *.tgz amass_linux_amd64
          chmod +x ~/recon-tools/*

      - name: Add Tools to PATH
        run: |
          echo "$HOME/recon-tools" >> $GITHUB_PATH
          echo "PATH=$HOME/recon-tools:$PATH" >> $GITHUB_ENV

      - name: Run Recon with Anew
        run: |
          mkdir -p sub_recon
          TARGET="miro.com"
          
          # Ensure master file exists
          touch sub_recon/all_subs.txt
          
          # Run everything and pipe through anew
          # anew will append new subs to all_subs.txt AND print them to new_subs.txt
          {
            subfinder -d $TARGET -silent
            assetfinder --subs-only $TARGET
            amass enum -passive -d $TARGET
          } | grep "$TARGET" | anew sub_recon/all_subs.txt > sub_recon/new_subs.txt

      - name: Check for Findings
        id: check
        run: |
          if [ -s sub_recon/new_subs.txt ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "count=$(wc -l < sub_recon/new_subs.txt)" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Notify Slack
        if: steps.check.outputs.found == 'true'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: files.uploadV2
          token: ${{ secrets.SLACK_BOT }}
          payload: |
            {
              "channel_id": "C0AGVMVMRT3",
              "initial_comment": "ðŸ†• `${{ steps.check.outputs.count }}` new subdomains found for `miro.com`!",
              "file": "./sub_recon/new_subs.txt",
              "filename": "new_subs.txt"
            }

      - name: Commit Master List
        if: steps.check.outputs.found == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add sub_recon/all_subs.txt
          git commit -m "Recon Update: +${{ steps.check.outputs.count }} subdomains"
          git push origin main
