name: Two-Repo Recon
on:
  schedule:
    - cron: "0 */1 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  recon:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Public Tools
        uses: actions/checkout@v4

      - name: Install Subfinder
        run: |
          LATEST_VERSION=$(curl -s https://api.github.com/repos/projectdiscovery/subfinder/releases/latest | jq -r '.tag_name' | sed 's/v//')
          curl -sL "https://github.com/projectdiscovery/subfinder/releases/download/v${LATEST_VERSION}/subfinder_${LATEST_VERSION}_linux_amd64.zip" -o subfinder.zip
          unzip -o subfinder.zip
          sudo mv subfinder /usr/local/bin/

      # This step clones your PRIVATE repo into a folder called 'results'
      - name: Checkout Private Results Repo
        uses: actions/checkout@v4
        with:
          repository: KeralaTOBi/recon-results # Change this!
          token: ${{ secrets.RESULTS_REPO_TOKEN }}
          path: results

      - name: Run Discovery
        run: |
          mkdir -p results/miro
          touch results/miro/all_subs.txt
          subfinder -d miro.com -silent > current_scan.txt

      - name: Compare and Update
        id: compare
        run: |
          # Find new subdomains
          grep -Fvxf results/miro/all_subs.txt current_scan.txt > new_subs.txt || true
          
          if [ -s new_subs.txt ]; then
            echo "new_found=true" >> $GITHUB_OUTPUT
            cat new_subs.txt >> results/miro/all_subs.txt
            sort -u results/miro/all_subs.txt -o results/miro/all_subs.txt
          else
            echo "new_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Push to Private Repo
        if: steps.compare.outputs.new_found == 'true'
        run: |
          cd results
          git config --local user.email "action@github.com"
          git config --local user.name "Recon Bot"
          git add miro/all_subs.txt
          git commit -m "Update Miro Subs: $(date +'%Y-%m-%d %H:%M')"
          git push origin main

      - name: Notify Slack
        if: steps.compare.outputs.new_found == 'true'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: files.uploadV2
          token: ${{ secrets.SLACK_BOT }}
          payload: |
            {
              "channel_id": "C0AGVMVMRT3",
              "initial_comment": "ðŸŽ¯ New Miro subdomains saved to private repo!",
              "file": "./new_subs.txt",
              "filename": "new_subs.txt"
            }
